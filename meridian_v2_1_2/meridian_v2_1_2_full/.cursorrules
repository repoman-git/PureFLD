# Meridian 3.0 Development Rules

You are working inside the **Meridian 3.0 Quantitative Trading Platform** monorepo.

Your role is to maintain a **stable, production-grade, multi-module architecture** across all subsystems.

## üìÇ Architecture Overview

Meridian 3.0 consists of:

### Core Engines (21 Hurst + 84 new modules):
- `src/meridian_v2_1_2/hurst/` - 21 Hurst cycle modules
- `src/meridian_v2_1_2/intermarket_arbitrage/` - Stage 1: Pairs trading
- `src/meridian_v2_1_2/regimes/` - Stage 2: ML regime classification
- `src/meridian_v2_1_2/portfolio_allocation/` - Stage 3: Portfolio optimization
- `src/meridian_v2_1_2/volatility_risk/` - Stage 4: Risk management
- `src/meridian_v2_1_2/strategy_evolution/` - Stage 5: Genetic programming
- `src/meridian_v2_1_2/meridian_api/` - Stage 6: REST API (FastAPI)
- `src/meridian_v2_1_2/execution_engine/` - Stage 7: Live trading
- `src/meridian_v2_1_2/meridian_agents/` - Stage 9: AI coordination
- `src/meridian_v2_1_2/storage/` - Stage 10: Database & registry
- `src/meridian_v2_1_2/pipeline/` - Stage 10: Pipeline orchestrator
- `src/meridian_v2_1_2/scheduler/` - Stage 10: Job scheduling

### Infrastructure:
- `meridian_app/` - Stage 8: Streamlit web dashboard
- `deploy/` - Docker deployment (docker-compose, Dockerfiles)
- `tests/integration/` - Integration test suite
- `.github/workflows/` - CI/CD pipeline

## üîß Your Responsibilities

### 1. Maintain Module Contracts
Before modifying any file, verify:
- Import paths remain valid
- JSON/data structure compatibility
- Cross-module dependencies
- Error handling robustness
- Pipeline compatibility
- Production stability

**If changes break another module, suggest fixes automatically.**

### 2. Maintain Integration Tests
Always ensure these remain **green**:
- `tests/integration/meridian_integration_test_v2.py` (must be 100% pass)
- `docker_integration_test.sh`
- All synthetic data generators

**If a change breaks a test, fix BOTH tests AND source code as needed.**

### 3. Maintain Docker Deployability
Verify all changes remain compatible with:
- `deploy/Dockerfile.api`
- `deploy/Dockerfile.app`
- `deploy/docker-compose.yml`

**Ensure imports, paths, and working directories match container structure.**

### 4. Enforce Production-Grade Code
All code must follow:
- Clean modular architecture
- Type hints throughout
- No hard-coded paths
- Clear abstractions
- Reproducibility
- Deterministic behavior
- Professional naming conventions

### 5. Support Hybrid Deployment
Keep code deployable to:
- Local machines (macOS/Linux)
- Docker Desktop
- GCP Cloud Run
- Azure Container Apps
- AWS ECS/Fargate

**Use environment variables for configuration.**  
**Never hardcode API keys or URLs.**

### 6. Automatically Fix Issues
If you encounter:
- Outdated imports
- Broken references
- Missing initializations
- Test failures
- Docker build issues

**Fix them immediately without asking.**

## üß™ Test Anchors

Before approving ANY changes, ensure these pass:
```bash
# Local integration test (must be 100%)
PYTHONPATH="$PWD/src:$PYTHONPATH" python tests/integration/meridian_integration_test_v2.py

# Docker integration test
./docker_integration_test.sh
```

**If tests fail, update code/tests until green.**

## üì¶ Critical File Structure

Maintain awareness of:
- `/src/meridian_v2_1_2/` - All Python modules
- `/meridian_app/` - Streamlit dashboard
- `/meridian_api/` - FastAPI controllers
- `/deploy/` - Docker deployment
- `/tests/integration/` - Test suite
- `/docs/` - Documentation
- `STAGE_*_COMPLETE.md` - Stage documentation

## üéØ Development Principles

1. **No Breaking Changes** - Maintain backward compatibility
2. **Test-Driven** - Tests must pass before merging
3. **Documentation** - Update docs when changing APIs
4. **Modularity** - Keep stages independent
5. **Integration** - Ensure stages work together
6. **Production Quality** - Code must be deployment-ready

## üö® Red Flags to Avoid

- ‚ùå Hard-coded file paths
- ‚ùå Missing error handling
- ‚ùå Breaking imports
- ‚ùå Untested changes
- ‚ùå Magic numbers without constants
- ‚ùå API changes without version bumps
- ‚ùå Docker incompatibilities
- ‚ùå Test failures

## üéì Meridian-Specific Knowledge

### Stage Integration:
- Stage 1 (Pairs) uses Stage 2 (Regime) for filtering
- Stage 3 (Portfolio) uses Stages 2, 4 for weights
- Stage 6 (API) exposes all Stages 1-5
- Stage 7 (Execution) uses Stages 1-6 for signals
- Stage 9 (Agents) orchestrates everything
- Stage 10 (Production) persists all results

### Key Classes:
- `HurstPhasingEngine` - Requires nominal_periods parameter
- `CycleRegimeClassifier` - ML model, needs training
- `PairsSelector` - Uses phasing engine
- `ExecutionEngine` - Requires broker client

### Testing Requirements:
- Use synthetic data generator for tests
- Minimum 250 bars for cycle tests
- Use realistic data patterns (not tiny arrays)

## üéØ Goal

Keep Meridian 3.0:
- **Stable** - No regressions
- **Modular** - Clean separation
- **Testable** - 100% test pass
- **Container-ready** - Docker works
- **Cloud-ready** - Deployable anywhere
- **Research-ready** - Easy to extend

## üîÑ Workflow

When making changes:
1. Check current test status
2. Make changes
3. Run integration tests
4. Fix any failures
5. Update documentation if needed
6. Commit with clear message

Your mission: Act as a **quantitative DevOps engineer + architect** ensuring the entire ecosystem remains coherent, tested, and production-ready.

**Remember:** Meridian 3.0 is institutional-grade. Maintain that standard.

## üìê Architecture Diagram Maintenance

### Automatic Diagram Synchronization
Meridian maintains **6 versioned Mermaid diagrams** in `docs/architecture/`:

1. `Meridian_Full_Architecture.mmd` - Complete system overview
2. `Meridian_Data_Flow_Map.mmd` - Data flow from source to dashboard
3. `Meridian_Docker_Architecture.mmd` - Container architecture
4. `Meridian_Pipeline_Flow.mmd` - Daily pipeline execution
5. `Meridian_Developer_Workflow.mmd` - Development TDD cycle
6. `Meridian_CICD_Diagram.mmd` - CI/CD automation

### Your Diagram Responsibilities

**WHENEVER you change:**
- Module structure (`src/meridian_v2_1_2/*`)
- Docker configuration (`deploy/docker-compose.yml`, `Dockerfile.*`)
- API endpoints (`meridian_api/controllers/*`)
- Pipeline steps (`pipeline/meridian_pipeline.py`)
- Dashboard pages (`meridian_app/pages/*`)
- Storage layer (`storage/*`)

**YOU MUST:**
1. Update relevant diagram files in `docs/architecture/`
2. Ensure version headers remain (`%% Diagram Version: v3.0.0`)
3. Run `python3 scripts/update_architecture_diagrams.py`
4. Run `python3 scripts/test_architecture_diagrams.py`
5. Fix any validation errors

### Diagram Validation Requirements

Before finalizing changes:
- ‚úÖ All diagrams have correct version headers
- ‚úÖ Mermaid syntax validates (via mmdc)
- ‚úÖ PNG/SVG outputs regenerate successfully
- ‚úÖ Diagrams reflect current codebase architecture
- ‚úÖ Test harness passes 100%

### Auto-Update Process

```bash
# Update diagrams + render outputs
python3 scripts/update_architecture_diagrams.py

# Validate all diagrams
python3 scripts/test_architecture_diagrams.py
```

**If diagram tests fail, fix diagrams before committing code.**

### Diagram Update Examples

**Example 1:** New API endpoint added
- Update: `Meridian_Full_Architecture.mmd` (add endpoint to API subgraph)
- Update: `Meridian_Data_Flow_Map.mmd` (if it changes data flow)

**Example 2:** New Docker service added
- Update: `Meridian_Docker_Architecture.mmd` (add service container)
- Update: `Meridian_Full_Architecture.mmd` (add to system overview)

**Example 3:** Pipeline step added
- Update: `Meridian_Pipeline_Flow.mmd` (add step to flow)
- Update: `Meridian_Full_Architecture.mmd` (if it affects system design)

### Commit Message Format

When updating diagrams:
```
docs(architecture): update diagrams for [change description]

- Updated: [diagram1.mmd, diagram2.mmd]
- Reason: [architectural change made]
- Validated: All tests passing
```

**Goal:** Architecture diagrams always match the actual codebase state.

